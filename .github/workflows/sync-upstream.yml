name: Auto Sync with Upstream

on:
  schedule:
    # Check for upstream changes every 15 minutes
    - cron: '*/15 * * * *'
  workflow_dispatch: # Allow manual triggering

jobs:
  sync:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout Fork
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0
      
      - name: Configure Git
        run: |
          git config user.name 'github-actions[bot]'
          git config user.email 'github-actions[bot]@users.noreply.github.com'
      
      - name: Add Upstream Remote
        run: |
          # IMPORTANT: Replace with your actual upstream repository
          git remote add upstream https://github.com/minh-hahaha/Global-Lab-Tour-Test
          git remote -v
      
      - name: Check for Upstream Changes
        id: check
        run: |
          git fetch upstream main
          
          # Get the latest commit hashes
          LOCAL_COMMIT=$(git rev-parse HEAD)
          UPSTREAM_COMMIT=$(git rev-parse upstream/main)
          
          echo "Local commit: $LOCAL_COMMIT"
          echo "Upstream commit: $UPSTREAM_COMMIT"
          
          if [ "$LOCAL_COMMIT" != "$UPSTREAM_COMMIT" ]; then
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "ðŸ“¦ New changes detected in upstream!"
          else
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "âœ… Fork is up to date with upstream"
          fi
      
      - name: Sync with Upstream
        if: steps.check.outputs.has_changes == 'true'
        run: |
          # Fetch all upstream branches and tags
          git fetch upstream --tags
          
          # Checkout main branch
          git checkout main
          
          # Merge or rebase with upstream
          git merge upstream/main --no-edit
          
          # Push to fork
          git push origin main --force-with-lease
          git push origin --tags
      
      - name: Create Issue for Notification
        if: steps.check.outputs.has_changes == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const title = 'ðŸ”„ Fork synced with upstream';
            const body = `Your fork has been automatically synced with the upstream repository at ${new Date().toISOString()}`;
            
            // Optional: Create an issue to notify about the sync
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: title,
              body: body,
              labels: ['auto-sync']
            });
